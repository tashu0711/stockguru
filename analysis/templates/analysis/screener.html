<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Screener - StockGuru</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body { background: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-scan {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
      transition: transform 0.2s;
    }
    .btn-scan:hover { transform: translateY(-2px); }
    .stock-card {
      border-radius: 12px;
      border: none;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .stock-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    .risk-badge { font-size: 0.85rem; padding: 8px 16px; border-radius: 8px; font-weight: 600; }
    .spinner-custom { width: 4rem; height: 4rem; border-width: 4px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark shadow-sm">
    <div class="container">
      <a href="{% url 'home' %}" class="navbar-brand fw-bold">
        <i class="bi bi-graph-up-arrow"></i> StockGuru
      </a>
      <div class="d-flex flex-wrap">
        <a href="{% url 'screener' %}" class="btn btn-sm btn-light me-2 mb-2 mb-md-0">
          <i class="bi bi-search"></i> Screener
        </a>
        <a href="{% url 'portfolio' %}" class="btn btn-sm btn-outline-light me-2 mb-2 mb-md-0">
          <i class="bi bi-briefcase"></i> Portfolio
        </a>
        <a href="{% url 'backtest' %}" class="btn btn-sm btn-outline-light mb-2 mb-md-0">
          <i class="bi bi-clock-history"></i> Backtest
        </a>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Header -->
    <div class="text-center mb-4">
      <h2 class="fw-bold">
        <i class="bi bi-search text-primary"></i> Smart Screener
      </h2>
      <p class="text-muted">Top 4 high volume stocks showing bounce signals</p>
    </div>

    <!-- Scan Button -->
    <form method="POST" id="screenForm" class="text-center mb-5">
      {% csrf_token %}
      <button type="submit" class="btn btn-lg btn-scan text-white px-5 py-3" id="screenBtn">
        <i class="bi bi-radar"></i> Scan Market Now
      </button>
      <div id="loading" class="d-none mt-4">
        <div class="spinner-border spinner-custom text-success" role="status"></div>
        <p class="mt-3 text-muted fw-semibold">Analyzing NIFTY stocks... (~1-2 minutes)</p>
      </div>
    </form>

    {% if error %}
      <div class="alert alert-danger rounded-3">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
      </div>
    {% endif %}

    <!-- Results -->
    {% if results %}
      <div class="alert alert-info rounded-3 mb-4">
        <i class="bi bi-check-circle"></i>
        Scanned <strong>{{ results.total_scanned }}</strong> stocks at <strong>{{ results.screened_at }}</strong>
      </div>

      {% if results.signals %}
        <h4 class="mb-4">
          <i class="bi bi-bullseye text-success"></i> Signals Detected
        </h4>
        {% for stock in results.signals %}
          <div class="card stock-card mb-4">
            <div class="card-body p-4">
              <div class="row align-items-center">
                <!-- Stock Info -->
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                  <h5 class="fw-bold mb-1">
                    <i class="bi bi-building"></i> {{ stock.ticker }}
                  </h5>
                  <small class="text-muted">
                    <i class="bi bi-trophy"></i> Volume Rank #{{ forloop.counter }}
                  </small>
                  <div class="mt-2">
                    <span class="badge risk-badge bg-{{ stock.risk_color }}">
                      {{ stock.risk_level }}
                    </span>
                  </div>
                </div>

                <!-- Price Info -->
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                  <div class="small text-muted mb-1">
                    <i class="bi bi-arrow-up-circle"></i> Open
                  </div>
                  <div class="fw-bold fs-5">₹{{ stock.open }}</div>
                  <div class="small text-muted mt-2 mb-1">
                    <i class="bi bi-arrow-down-circle"></i> Current
                  </div>
                  <div class="fw-bold fs-5">₹{{ stock.current }}</div>
                  <span class="badge bg-danger mt-2">{{ stock.change_pct }}%</span>
                </div>

                <!-- Targets -->
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                  <div class="small">
                    <i class="bi bi-target text-success"></i>
                    <strong>Target:</strong> ₹{{ stock.target_price }} <span class="text-success">(+2.5%)</span>
                  </div>
                  <div class="small mt-2">
                    <i class="bi bi-shield-x text-danger"></i>
                    <strong>Stop Loss:</strong> ₹{{ stock.stop_loss }} <span class="text-danger">(-3%)</span>
                  </div>
                  <div class="small mt-2 text-muted">
                    <i class="bi bi-calendar-week"></i> Hold: {{ stock.hold_period }}
                  </div>
                </div>

                <!-- Buy Button -->
                <div class="col-lg-3 col-12">
                  <form method="POST" action="{% url 'buy_stock' %}">
                    {% csrf_token %}
                    <input type="hidden" name="ticker" value="{{ stock.ticker }}">
                    <input type="hidden" name="price" value="{{ stock.current }}">
                    <div class="input-group input-group-sm mb-2">
                      <span class="input-group-text">
                        <i class="bi bi-box"></i>
                      </span>
                      <input type="number" name="quantity" value="1" min="1" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-cart-plus"></i> Buy (Virtual)
                    </button>
                  </form>
                </div>
              </div>

              <!-- Strategy Note -->
              <div class="alert alert-light mb-3 mt-3">
                <i class="bi bi-lightbulb"></i> <strong>Strategy:</strong> {{ stock.exit_note }}
              </div>

              <!-- News Sentiment -->
              {% if stock.sentiments %}
                <div class="mt-3">
                  <h6 class="fw-bold">
                    <i class="bi bi-newspaper"></i> News Sentiment
                    <span class="badge bg-secondary">Avg: {{ stock.avg_sentiment|floatformat:2 }}</span>
                  </h6>
                  <ul class="list-unstyled mt-2">
                    {% for sent in stock.sentiments %}
                      <li class="small mb-2">
                        <span class="badge {% if sent.score > 0.1 %}bg-success{% elif sent.score < -0.1 %}bg-danger{% else %}bg-secondary{% endif %}">
                          {{ sent.score|floatformat:2 }}
                        </span>
                        {{ sent.text }}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <p class="text-muted small mt-3">
                  <i class="bi bi-info-circle"></i> No recent news available
                </p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-warning rounded-3">
          <i class="bi bi-exclamation-circle"></i>
          No negative stocks in top 4 volume today. Market is bullish!
        </div>
      {% endif %}

      <!-- Top Volume Table -->
      <h5 class="mt-5 mb-3">
        <i class="bi bi-bar-chart-line"></i> Top 4 Volume Stocks
      </h5>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th><i class="bi bi-hash"></i> Rank</th>
              <th><i class="bi bi-building"></i> Ticker</th>
              <th><i class="bi bi-speakers"></i> Volume</th>
              <th><i class="bi bi-graph-up-arrow"></i> Change %</th>
            </tr>
          </thead>
          <tbody>
            {% for stock in results.top_volume %}
              <tr>
                <td class="fw-bold">#{{ forloop.counter }}</td>
                <td><strong>{{ stock.ticker }}</strong></td>
                <td>{{ stock.volume|floatformat:0 }}</td>
                <td>
                  <span class="badge {% if stock.change_pct < 0 %}bg-danger{% else %}bg-success{% endif %}">
                    {{ stock.change_pct }}%
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <script>
    document.getElementById('screenForm').addEventListener('submit', function() {
      document.getElementById('screenBtn').disabled = true;
      document.getElementById('loading').classList.remove('d-none');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
